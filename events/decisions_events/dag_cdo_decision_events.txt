namespace = dag_cdo_decision_event

#~Ruler browsing slave market
dag_cdo_decision_event.1000 = {
	type = character_event
	title = {
		desc = dag_cdo_decision_event.1000.t
	}
	
	desc = {
		desc = dag_cdo_decision_event.1000.desc
	}
	theme = dag_cdo_theme_slavery
	left_portrait = scope:high_skill_option
	right_portrait = scope:low_skill_option
	lower_right_portrait = scope:excellent_skill_option

	trigger = { exists = capital_province } #~If I lost it before I got this event, I shouldn't get a slave
	
	immediate = {
		hidden_effect = {
			#~Find an available slaver in case we need one.
			random_living_character = {
				limit = {
					in_diplomatic_range = root
					has_character_modifier = dag_cdo_slavers_guild_member
				}
				save_scope_as = slaver_character
			}
			#~Backup generation
			if = {
				limit = { NOT = { exists = scope:slaver_character } }
				dag_cdo_create_slaver_effect = yes
				scope:created_character = { save_scope_as = slaver_character }
			}
			#~Find some appropriate options
			if = { #Performance heavy option finding is only for players (Not sure if needed as the AI should never trigger this event)
				limit = { is_ai = no }
				#EXCELLENT SKILL CHARACTER (for high stewardship rulers)
				if = {
					limit = {
						OR = {
							has_stewardship_lifestyle_trait_trigger = yes
							stewardship >= high_skill_rating
						}
					}
					random_living_character = {
						limit = {
							has_trait = slave
							carn_slave_can_be_sold_trigger = yes
							carn_slave_price_value >= 25
							NOT = { has_relation_slave_owner = root }
						}
						save_scope_as = excellent_skill_option
						dag_cdo_slave_fix_missing_master_effect = { SLAVE = scope:excellent_skill_option }
					}
					#~Backup generation
					if = {
						limit = { NOT = { exists = scope:excellent_skill_option } }
						dag_cdo_create_slave_excellent_effect = { OWNER = scope:slaver_character }
						scope:created_character = {
							save_scope_as = excellent_skill_option
						}
					}
				}
				#~HIGH-SKILL CHARACTER
				random_living_character = {
					limit = {
						in_diplomatic_range = root
						has_trait = slave
						carn_slave_can_be_sold_trigger = yes
						carn_slave_price_value >= 5
						NOT = { has_relation_slave_owner = root }
						dag_cdo_slave_is_missing_master_trigger = yes
						trigger_if = {
							limit = {
								exists = scope:excellent_skill_option
							}
							NOT = { this = scope:excellent_skill_option }
						}
					}
					save_scope_as = high_skill_option
					dag_cdo_slave_fix_missing_master_effect = { SLAVE = scope:high_skill_option }
				}
				#~Backup generation
				if = {
					limit = { NOT = { exists = scope:high_skill_option } }
					dag_cdo_create_slave_high_effect = { OWNER = scope:slaver_character }
					scope:created_character = {
						save_scope_as = high_skill_option
					}
				}
				#~Low-medium skill character
				random_living_character = {
					limit = {
						in_diplomatic_range = root
						has_trait = slave
						carn_slave_can_be_sold_trigger = yes
						NOT = { has_relation_slave_owner = root }
						trigger_if = {
							limit = {
								exists = scope:excellent_skill_option
							}
							NOT = { this = scope:excellent_skill_option }
						}
						trigger_if = {
							limit = {
								exists = scope:high_skill_option
							}
							NOT = { this = scope:high_skill_option }
						}
					}
					save_scope_as = low_skill_option
					dag_cdo_slave_fix_missing_master_effect = { SLAVE = scope:low_skill_option }
				}
			}
			else = { #~Ai get someone simple
				random_pool_character = {
					province = root.capital_province
					limit = {
						has_trait = slave
					}
					save_scope_as = low_skill_option
					dag_cdo_slave_fix_missing_master_effect = { SLAVE = scope:low_skill_option }
				}
			}
			#~Backup generation
			if = {
				limit = { NOT = { exists = scope:low_skill_option } }
				dag_cdo_create_slave_low_effect = { OWNER = scope:slaver_character }
				scope:created_character = {
					save_scope_as = low_skill_option
				}
			}
		}
	}

	#~Amazing skill
	option = {
		trigger = { exists = scope:excellent_skill_option }
		name = dag_cdo_decision_event.1000.a
		root = { save_scope_as = buyer }	#~NB: Do not use scope:root, because you will waste hours of your life if you do.
		scope:excellent_skill_option = {
			random_relation = {
				type = slave_owner
				save_scope_as = seller
			}
			save_scope_as = slave
		}
		carn_buy_slave_effect = { 
			SLAVE_PRICE = scope:excellent_skill_option.carn_slave_price_value
		}
		ai_chance = {
			factor = 500
			modifier = {
				short_term_gold < medium_gold_value
				factor = 0
			}
		}
	}

	#~High skill
	option = {
		trigger = { exists = scope:high_skill_option }
		name = dag_cdo_decision_event.1000.b
		root = { save_scope_as = buyer }	#~NB: Do not use scope:root, because you will waste hours of your life if you do.
		scope:high_skill_option = {
			random_relation = {
				type = slave_owner
				save_scope_as = seller
			}
			save_scope_as = slave 
		}
		carn_buy_slave_effect = { 
			SLAVE_PRICE = scope:high_skill_option.carn_slave_price_value
		}
		ai_chance = {
			factor = 100
			modifier = {
				short_term_gold < medium_gold_value
				factor = 0
			}
		}
	}

	#Low
	option = {
		trigger = { exists = scope:low_skill_option }	#~Should be true
		name = dag_cdo_decision_event.1000.c
		root = { save_scope_as = buyer }	#~NB: Do not use scope:root, because you will waste hours of your life if you do.
		scope:low_skill_option = {
				random_relation = {
					type = slave_owner
					save_scope_as = seller
				}
			save_scope_as = slave
		}
		carn_buy_slave_effect = {
			SLAVE_PRICE = scope:low_skill_option.carn_slave_price_value
		}
		ai_chance = {
			factor = 100
		}
	}

	#~None...
	option = {
		name = dag_cdo_decision_event.1000.d
		custom_tooltip = dag_cdo_decision_event.1000.d.tt

		ai_chance = {
			base = 50
		}
	}

	after = {
		remove_character_flag = dag_cdo_searching_for_slave_decision_text	
	}
}
