decisions = {

	dwse_starting_trait = {
		is_high_prio = yes
		potential = {
			ai = no # Only the player should ever see this
			has_dwse_start = yes
			has_dwse_started = no
		}
		allow = {
			always = yes # It should always be displayed if it is relevant
		}
		effect = {
			set_global_flag = dwse_started
			narrative_event = { id = dwseliz.1 }
		}
		ai_will_do = {
			factor = 0 # Zero chance the ai uses this
		}
	}
}
offmap_decisions = {
	dwse_dragon_marriage = {
		only_playable = yes
		button_name = dwse_boons
		third_party_filter = realm_including_me
		ai_third_party_filter = court
		third_party = FROM
		ai_check_interval = 6
		show_third_party_potential = yes
		
		from_potential = {
			is_landed = yes
			OR = {
				has_dwse_lizards_yes = yes
				has_dwse_lizards_marriage = yes
			}
			NOT = {
				has_dwse_no_empire = yes
			}
			NOT = { trait = dwf_ghost }
		}

		potential = {
			is_offmap_tag = offmap_dwse
		}

		allow = {
			show_only_failed_conditions = yes
			OR = {
				AND = {	
					FROM = {
						show_scope_change = no
						conditional_tooltip = {
							trigger = { NOT = { has_character_modifier = peace_deal_with_china } }
							has_offmap_currency = { offmap = offmap_dwse value = 1000 }
						}
						conditional_tooltip = {
							trigger = { has_character_modifier = peace_deal_with_china }
							has_offmap_currency = { offmap = offmap_dwse value = 750 }
						}
						OR = {
							custom_tooltip = {
								text = can_marry_chinese_royal_tt
								AND = {
									is_adult = yes
									is_married = no
								}
							}
							custom_tooltip = {
								text = has_courtier_eligible_for_marriage_tt
								OR = {
									any_dynasty_member = {
										is_adult = yes
										is_married = no
										liege = { character = ROOT_FROM }
									}
									any_close_relative = {
										is_adult = yes
										is_married = no
										liege = { character = ROOT_FROM }
										NOT = { any_spouse = { character = ROOT_FROM } } #turns out without this, it includes your spouse
									}
								}
							}
						}
						prisoner = no
						NOT = { trait = incapable }
						is_inaccessible_trigger = no
					}
					china_offmap_boon_decisions_enabled_trigger = yes
				}
				FROM = {
					trait = yiminhyee
				}	
			}	
		}

		third_party_potential = {
			show_only_failed_conditions = yes
			FROMFROM = {
				show_scope_change = no
				OR = {
					dynasty = ROOT_FROM
					is_close_relative = ROOT_FROM
					AND = {
						ROOT_FROM = {
							trait = yiminhyee
						}
						OR = {
							trait = minhyee
							any_owned_bloodline = {	
								has_bloodline_flag = bloodline_minhyeesblood
							}	
						}
					}
				}
				OR = {
					character = ROOT_FROM
					AND = {
						liege = { character = ROOT_FROM }
						ai = yes
					}
				}
				NOT = { any_spouse = { character = ROOT_FROM } } 
				OR = {
					is_adult = yes	
					AND = {
						ROOT_FROM = {
							trait = yiminhyee
						}
						age = 11
					}
				}
				is_betrothed = no
			}
		}

		third_party_allow = {
			show_only_failed_conditions = yes
			OR = {
				FROMFROM = {
					custom_tooltip = {
						text = can_marry_chinese_royal_tt
						OR = {
							AND = {
								religion = lilitu
								ROOT_FROM = {
									trait = yiminhyee
								}
							}
							can_marry = yes
						}
						is_married = no
					}
				}
				FROMFROM = {
					trait = yiminhyee
				}
			}
		}

		effect = {
			FROM = {
				if = {
					limit = {
						trait = yiminhyee
					}
					add_offmap_currency = {
						offmap = offmap_dwse
						value = 10000
					}
					add_offmap_currency = {
						offmap = offmap_china
						value = 10000
					}
				}
				show_scope_change = no
				sound_effect = china_grace_spend
				if = {
					limit = { has_character_modifier = peace_deal_with_china }
					add_offmap_currency = {
						offmap = offmap_dwse
						value = -750
					}
				}
				else = {
					add_offmap_currency = {
						offmap = offmap_dwse
						value = -1000
					}
					custom_tooltip = { text = chinese_imperial_marriage_peace_deal_tt }	
				}				
			}
			if = { 
				limit = { FROMFROM = { is_female = yes } } 
				custom_tooltip = { text = chinese_imperial_marriage_prince_effect_tt }
			}
			if = { 
				limit = { FROMFROM = { is_female = no } } 
				custom_tooltip = { text = chinese_imperial_marriage_princess_effect_tt }
			}
			hidden_effect = { FROMFROM = { add_trait = cannot_marry } }
			hidden_effect = { offmap_dwse = { governor = { character_event = { id = dwseliz.20045 } } } }
			hidden_effect = { FROM = { set_china_boon_cd_effect = yes } }
			FROM = {
				if = {
					limit = {
						ai = no
					}
					hidden_effect = { set_character_flag = achievement_imperial_marriage }
				}
			}
			FROMFROM = { set_character_flag = awaiting_imperial_wedding }
		}

		revoke_allowed = {
			always = no
		}

		ai_will_do = {
			factor = 1
			modifier = {
				factor = 0.1 # slow down
			}
			modifier = {
				factor = 0.5
				FROM = {
					NOT = {
						higher_tier_than = DUKE
					}
				}
			}
			modifier = {
				factor = 0.75
				FROM = {
					NOT = {
						independent = yes
					}
				}
			}
		}
	}

}
