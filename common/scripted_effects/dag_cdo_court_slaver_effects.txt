#~dag_cdo_set_court_slaver_effect
#~dag_cdo_fire_court_slaver_effect
#~dag_cdo_invalidate_slaver_effect
#~dag_cdo_save_court_slaver_as_effect


dag_cdo_set_court_slaver_effect = {
	$SLAVER$ = {
		custom_tooltip = dag_cdo_set_court_slaver_effect.tt
		#~Court Physicians and knights are directly blocked from leaving by name
		#~if we don't want to edit 'courtier_allowed_to_leave_trigger' we need a work around
		#~NB: This is another one of those flags that the game very much regards as a guideline not a rule, it's barely ever checked.
		hidden_effect = { add_character_flag = { flag = blocked_from_leaving } }
	}

	$EMPLOYER$ = {
		hidden_effect = { set_relation_dag_cdo_court_slaver = $SLAVER$ }

		every_relation = {
			type = dag_cdo_court_slaver
			limit = { NOT = { this = $SLAVER$ } }

			save_temporary_scope_as = old_physician
			dag_cdo_fire_court_slaver_effect = {
				SLAVER = scope:old_physician
				EMPLOYER = $EMPLOYER$
			}
		}
	}
	
	#In case we saved someone who shouldn't be a court slaver (must be done this way rather than wrapping everything in an if for tooltip reasons when SLAVER isn't your courtier yet)
	dag_cdo_invalidate_slaver_effect = {
		SLAVER = $SLAVER$
		EMPLOYER = $EMPLOYER$
	}
}

dag_cdo_fire_court_slaver_effect = {
	$SLAVER$ = { 
		custom_tooltip = dag_cdo_fire_court_slaver_effect.tt
		hidden_effect = { remove_character_flag = blocked_from_leaving }	#~this could interact badly with other effects
		}
	$EMPLOYER$ = {
		if = {
			limit = {
				has_relation_dag_cdo_court_slaver = $SLAVER$
			}
			hidden_effect = { remove_relation_dag_cdo_court_slaver = $SLAVER$ }

			reverse_add_opinion = {
				target = $SLAVER$
				modifier = disappointed_opinion
				opinion = -15
			}
		}
	}
}

dag_cdo_invalidate_slaver_effect = {
	hidden_effect = {
		if = {
			limit = {
				NOT = { $SLAVER$ = { dag_cdo_can_be_court_slaver_of = { EMPLOYER = $EMPLOYER$ } } }
			}
			$SLAVER$ = { save_scope_as = invalidated_slaver }
			$EMPLOYER$ = {
				send_interface_message = {
					type = event_court_physician_bad
					title = dag_cdo_invalidate_slaver_effect.t
					left_icon = scope:invalidated_slaver
					remove_relation_dag_cdo_court_slaver = $SLAVER$
				}
			}
		}
	}
}

dag_cdo_save_court_slaver_as_effect = {
	hidden_effect = {
		if = { 	
			limit = { exists = court_owner }
			court_owner = {
				save_temporary_scope_as = save_slaver_employer
				every_relation = {
					type = dag_cdo_court_slaver
					save_temporary_scope_as = save_slaver_slaver
					dag_cdo_invalidate_slaver_effect = {
						SLAVER = scope:save_slaver_slaver
						EMPLOYER = scope:save_slaver_employer
					}
				}
				random_relation = {
					type = dag_cdo_court_slaver
					save_scope_as = $SCOPE_NAME$
				}
			}
		}
	}
}
