#Effect to select and fire a generic Carnalitas Sex scene
#Code pulled from the Carnalitas sex interaction

#~NB: firing a Carnalitas Sex scene this way causes issues with carn_undress_character_effect/carn_dress_character_effect
#~Are we sure about that, how the fuck do we think they are being called?
#~The issue is nothing to fucking do with Carnalitas, its bloody adroitGenericVaginalSexSceneEvents not using carn_dress_character_effect
#~ie_consensual_sex_scene_missionary is just as bad and that fires like 9billion times cos they upped the weight

#~TBH: It may be that trying to give characters the is_naked character_flag for the whole orgy is just an unrealistic proposition
#~well it's unrealistic if you use other mods, yes

#~Most of the time, the event will imply that the TARGET is giving consent
dag_cdo_consensual_sex_effect = {
	show_as_tooltip = {
		carn_had_sex_with_effect = {
			CHARACTER_1 = $ACTOR$
			CHARACTER_2 = $TARGET$
			C1_PREGNANCY_CHANCE = pregnancy_chance
			C2_PREGNANCY_CHANCE = pregnancy_chance
			STRESS_EFFECTS = yes
			DRAMA = yes
		}
	}
	carn_sex_scene_request_consensual = yes
	IF = {
		limit = { 
			NOR = {
				$ACTOR$ = { is_ai = yes }
				has_game_rule = carn_sex_interaction_disabled
			}
		}
		#~actually fire the sex scene
		carn_sex_scene_effect = {
			PLAYER = $ACTOR$
			TARGET = $TARGET$
			STRESS_EFFECTS = yes
			DRAMA = yes
		}
	}
	Else = {
		carn_had_sex_with_effect = {
			CHARACTER_1 = $ACTOR$
			CHARACTER_2 = $TARGET$
			C1_PREGNANCY_CHANCE = pregnancy_chance
			C2_PREGNANCY_CHANCE = pregnancy_chance
			STRESS_EFFECTS = yes
			DRAMA = yes
		}
	}
}

#~For when we don't know how much the TARGET is into it: Slaves, Prostitutes, Concubines, etc.
dag_cdo_pressured_sex_effect = {
	show_as_tooltip = {
		carn_had_sex_with_effect = {
			CHARACTER_1 = $PLAYER$
			CHARACTER_2 = $TARGET$
			C1_PREGNANCY_CHANCE = pregnancy_chance
			C2_PREGNANCY_CHANCE = pregnancy_chance
			STRESS_EFFECTS = yes
			DRAMA = yes
		}
	}

	# request the sex scene

	# lovers and soulmates always consensual
	if = {
		limit = {
			$PLAYER$ = {
				OR = {
					has_relation_lover = $TARGET$
					has_relation_soulmate = $TARGET$
				}
			}
		}
		carn_sex_scene_request_consensual = yes
	}
	# for slaves and concubines, get scenes ranging from consensual to noncon
	else_if = {
		limit = {
			$PLAYER$ = {
				OR = {
					is_concubine_of = $TARGET$
					has_relation_slave_owner = $TARGET$
				}
			}
		}
		# Consensual: I'm into you, and I either like you or you're super hot
		if = {
			limit = {
				$TARGET$ = {
					OR = {
						opinion = {
							target = $PLAYER$
							value >= 50
						}
						$PLAYER$ = { attraction >= 20 } # if you're hot enough they'll happily hatefuck you
					}
					is_attracted_to_gender_of = $PLAYER$
				}
			}
			carn_sex_scene_request_consensual = yes
		}
		# Dubcon: Either I'm into you but not that into you, or I don't swing that way but I like you enough to humor you
		else_if = {
			limit = {
				$TARGET$ = {
					OR = {
						AND = {
							is_attracted_to_gender_of = $PLAYER$
							OR = {
								opinion = {
									target = $PLAYER$
									value > 0
								}
								$PLAYER$ = { attraction >= 10 } # if you're hot enough they'll be kinda ok with it
							}
						}
						AND = {
							NOT = { is_attracted_to_gender_of = $PLAYER$ }
							opinion = {
								target = $PLAYER$
								value >= 75
							}
						}
					}
				}
			}
			carn_sex_scene_request_dubcon = yes
			carn_sex_scene_request_dom_player = yes
		}
		# Noncon: I either hate you or I don't swing this way, get me outta here
		else = {
			carn_sex_scene_request_noncon = yes
			carn_sex_scene_request_dom_player = yes
		}
	}
	# get dubcon for characters that dislike you / are not attracted to you (but accept sex with you for some reason, like being a prostitute)
	else_if = {
		limit = {
			$TARGET$ = {
				OR = {
					opinion = {
						target = $PLAYER$
						value < 0
					}
					NOT = { is_attracted_to_gender_of = $PLAYER$ }
				}
			}
		}
		carn_sex_scene_request_dubcon = yes
		carn_sex_scene_request_dom_player = yes
	}
	# fallback to consensual scene
	else = {
		carn_sex_scene_request_consensual = yes
	}

	IF = {
		limit = { NOT = { has_game_rule = carn_sex_interaction_disabled } }
		# actually fire the sex scene
		carn_sex_scene_effect = {
			PLAYER = $PLAYER$
			TARGET = $TARGET$
			STRESS_EFFECTS = yes
			DRAMA = yes
		}
	}
	Else = {
		carn_had_sex_with_effect = {
			CHARACTER_1 = $PLAYER$
			CHARACTER_2 = $TARGET$
			C1_PREGNANCY_CHANCE = pregnancy_chance
			C2_PREGNANCY_CHANCE = pregnancy_chance
			STRESS_EFFECTS = yes
			DRAMA = yes
		}
	}
}

dag_cdo_threesome_effect = {
	show_as_tooltip = {
		carn_had_sex_with_effect = {
			CHARACTER_1 = $PLAYER$
			CHARACTER_2 = $TARGET_ONE$
			C1_PREGNANCY_CHANCE = pregnancy_chance
			C2_PREGNANCY_CHANCE = pregnancy_chance
			STRESS_EFFECTS = yes
			DRAMA = yes
		}
	}

	show_as_tooltip = {
		carn_had_sex_with_effect = {
			CHARACTER_1 = $PLAYER$
			CHARACTER_2 = $TARGET_TWO$
			C1_PREGNANCY_CHANCE = pregnancy_chance
			C2_PREGNANCY_CHANCE = pregnancy_chance
			STRESS_EFFECTS = yes
			DRAMA = yes
		}
	}

	#~we do not ask for a sex scene as none exist (yet)

	#~Hiding the actual effects in case someone comes along with a system that generates sex_scenes

	hidden_effect = {
		carn_had_sex_with_effect = {
			CHARACTER_1 = $PLAYER$
			CHARACTER_2 = $TARGET_ONE$
			C1_PREGNANCY_CHANCE = pregnancy_chance
			C2_PREGNANCY_CHANCE = pregnancy_chance
			STRESS_EFFECTS = yes
			DRAMA = yes
		}
		carn_had_sex_with_effect = {
			CHARACTER_1 = $PLAYER$
			CHARACTER_2 = $TARGET_TWO$
			C1_PREGNANCY_CHANCE = pregnancy_chance
			C2_PREGNANCY_CHANCE = pregnancy_chance
			STRESS_EFFECTS = yes
			DRAMA = yes
		}
		##Stuff janked from game core follows
		if = {	#Determine if the primary & secondary seducees also slept together, or if they just slept with you.
			limit = {
				matching_gender_and_sexuality_trigger = {
					CHARACTER_1 = $TARGET_ONE$
					CHARACTER_2 = $TARGET_TWO$
				}
			}
			$TARGET_ONE$ = {
				progress_towards_lover_effect = {	#Partners bond over the experience.
					CHARACTER = $TARGET_TWO$
					OPINION = 20
				}
			}
			carn_had_sex_with_effect = {
				CHARACTER_1 = $TARGET_ONE$
				CHARACTER_2 = $TARGET_TWO$
				C1_PREGNANCY_CHANCE = pregnancy_chance
				C2_PREGNANCY_CHANCE = pregnancy_chance
				STRESS_EFFECTS = yes
				DRAMA = yes
			}
		}
	}
}

dag_cdo_had_sex_with_unknown_partner = {						#~Warning, this has a 5% of providing a STD
	$CHARACTER$ = { save_scope_as = sex_character }
	random_list = {
		50 = {
			trigger = {
				scope:sex_character = { is_attracted_to_men = yes }
			}
			scope:sex_character = {			
				had_sex_with_unknown_effect = {					#Placeholder as there is no Carn version of this	
					GENDER = male
				}
			}
		}
		50 = {
			trigger = {
				scope:sex_character = { is_attracted_to_women = yes }
			}
			scope:sex_character = {
				had_sex_with_unknown_effect = {
					GENDER = female
				}
			}
		}
	}
}

dag_cdo_had_sex_with_unknown_no_std_effect = {
	save_temporary_scope_value_as = {
		name = gender
		value = flag:$GENDER$
	}

	#Stress release
	if = {
		limit = {
			OR = {
				has_trait = lustful
				has_trait = lifestyle_reveler
			}
		}
		add_stress = minor_stress_loss
	}

	#Sodomy
	if = {
		limit = { scope:gender = flag:male }
		give_homosexual_secret_or_nothing_with_target_effect = { CHARACTER = dummy_male }
	}

	hidden_effect = {
		#Adultery suspicion
		set_variable = {
			name = had_recent_sex
			value = flag:$GENDER$
		}
		random = {
			chance = 5
			random_spouse = {
				limit = { is_ai = no }
				alternative_limit = { always = yes }
				trigger_event = adultery.0001
			}
		}
		#~I would have triggered carn_on_sex here, but that expects a sex_partner
	}
}

dag_cdo_had_sex_with_unknown_partner_no_std = {					#~
	$CHARACTER$ = { save_scope_as = sex_character }
	random_list = {
		50 = {
			trigger = {
				scope:sex_character = { is_attracted_to_men = yes }
			}
			scope:sex_character = {			
				dag_cdo_had_sex_with_unknown_no_std_effect = {	
					GENDER = male
				}
			}
		}
		50 = {
			trigger = {
				scope:sex_character = { is_attracted_to_women = yes }
			}
			scope:sex_character = {
				dag_cdo_had_sex_with_unknown_no_std_effect = {
					GENDER = female
				}
			}
		}
	}
}

#########################################################################################
# These effects are meant for streamlining sex events

dag_cdo_make_sex_player_and_sex_target_naked_for_this_event_effect = {		#~I admit this is petty
	scope:carn_sex_player = {
		if = {
			limit = { is_ai = no }
			carn_undress_character_effect = yes
			scope:carn_sex_target = {
				carn_undress_character_effect = yes
			}
		}
	}
}

dag_cdo_make_sex_player_and_sex_target_no_longer_naked_effect = {
	scope:carn_sex_player = { carn_dress_character_effect = yes }
	scope:carn_sex_target = { carn_dress_character_effect = yes }
}

dag_cdo_remove_sex_consequences_character_effect = {
	if = {
		limit = {
			NOT = { has_character_flag = carn_no_consequences_for_extramarital_sex_with_others }
		}
		add_character_flag = {
			flag = carn_no_consequences_for_extramarital_sex_with_others
			days = 180 # So character won't stay naked forever when something goes wrong
		}
	}
	else = {
		# A local variable will be automatically removed after the event chain has been completed.
		set_local_variable = {
			name = character_was_already_no_consequences
			value = yes
		}
	}
}

dag_cdo_restore_sex_consequences_character_effect = {
	if = {
		limit = {
			NOT = { exists = local_var:character_was_already_no_consequences }
		}
		remove_character_flag = carn_no_consequences_for_extramarital_sex_with_others
	}
}













