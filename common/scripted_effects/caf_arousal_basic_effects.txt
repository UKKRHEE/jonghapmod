# caf_add_arousal
# caf_arousal_seeding

caf_add_arousal = {

	# In case arousal has not been set yet
	caf_arousal_seeding = yes

	# Store old level for later
	save_temporary_scope_value_as = {
		name = old_arousal_level
		value = caf_arousal_level
	}

	save_temporary_scope_value_as = {
		name = arousal_change
		value = $VALUE$
	}

	# Adjust gain/loss according to difficulty
	if = {
		limit = { scope:arousal_change > 0 }
		change_variable = {
			name = arousal
			add = caf_arousal_gain_total
		}
		set_variable = {
			name = arousal_change_total
			value = caf_arousal_gain_total
		}
	}
	else_if = {
		limit = { scope:arousal_change < 0 }
		change_variable = {
			name = arousal
			add = caf_arousal_loss_total
		}
		set_variable = {
			name = arousal_change_total
			value = caf_arousal_loss_total
		}
	}

	# Arousal level changed (hud)
	set_variable = {
		name = arousal_level
		value = caf_arousal_level
	}

	# Show text
	if = {
		limit = { 
			scope:arousal_change > 0
			# Would the added arousal add up to a new level? At the time the tooltip is evaluated, scope:old_arousal_level and caf_arousal_level are still equal.
			100 <= { value = caf_arousal modulo = 100 add = caf_arousal_gain_total }
		}
		custom_description = {
			text = caf_add_arousal_critical
			value = caf_arousal_gain_total
		}
	}
	else_if = {
		limit = { scope:arousal_change > 0 }
		custom_description = {
			text = caf_add_arousal
			value = caf_arousal_gain_total
		}
	}
	else_if = {
		limit = { scope:arousal_change < 0 }
		custom_description = {
			text = caf_add_arousal
			value = caf_arousal_loss_total
		}
	}

	# Arousal level increased
	if = {
		limit = { scope:old_arousal_level < caf_arousal_level }
		if = {
			limit = { caf_arousal_level = 1 }
			trigger_event = { on_action = caf_on_arousal_level_1 }
		}
		else_if = {
			limit = { caf_arousal_level = 2 }
			trigger_event = { on_action = caf_on_arousal_level_2 }
		}
		else_if = {
			limit = { caf_arousal_level = 3 }
			trigger_event = { on_action = caf_on_arousal_level_3 }
		}		
	}
	# Arousal level decreased
	else_if = {
		limit = { scope:old_arousal_level > caf_arousal_level }
		trigger_event = { on_action = caf_on_arousal_level_reduced }
	}
	# Arousal exceeds maximum
	else_if = {
		limit = { caf_arousal >= 400 }
		trigger_event = { on_action = caf_on_arousal_level_4 }
	}

	# Keep result in Range [0,400]
	if = {
		limit = { caf_arousal > 400 }
		set_variable = {
			name = arousal
			value = 400
		}
	}
	else_if = {
		limit = { caf_arousal < 0 }
		set_variable = {
			name = arousal
			value = 0
		}
	}
}

# Not much in the way of 'seeding' right now, but could be overwritten by other mods
caf_arousal_seeding = {
	if = {
		limit = {
			NOT = { has_variable = arousal }
		}
		set_variable = {
			name = arousal
			value = 0
		}
	}
}